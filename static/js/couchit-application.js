Date.parseRFC3339=function(c){var b=new Date(0);var a=c.match(/(\d{4})-(\d\d)-(\d\d)\s*(?:[\sT]\s*(\d\d):(\d\d)(?::(\d\d))?(\.\d*)?\s*(Z|([-+])(\d\d):(\d\d))?)?/);if(!a){return}if(a[2]){a[2]--}if(a[7]){a[7]=(a[7]+"000").substring(1,4)}var e=[null,"FullYear","Month","Date","Hours","Minutes","Seconds","Milliseconds"];for(var d=1;d<=7;d++){if(a[d]){b["setUTC"+e[d]](a[d])}}if(a[9]){b.setTime(b.getTime()+(a[9]=="-"?1:-1)*(a[10]*3600000+a[11]*60000))}return b.getTime()};function localizeDates(){var b="";var a=new Date();$$("time").each(function(e,d){if(e.getAttribute("title")=="GMT"){var c=new Date(Date.parseRFC3339(e.getAttribute("datetime")));if(!c.getTime()){return}diff=((a.getTime()-c.getTime())/1000),day_diff=Math.floor(diff/86400);if(isNaN(day_diff)||day_diff<0||day_diff>=31){return}var g=c.toLocaleString();var f=c.toLocaleString();if(day_diff==0){g=(diff<60&&"Just Now"||diff<120&&"1 minute ago"||diff<3600&&Math.floor(diff/60)+" minutes ago"||diff<7200&&"1 hour ago"||diff<86400&&Math.floor(diff/3600)+" hours ago");f=c.toLocaleTimeString()}else{hours=c.getHours();minutes=c.getMinutes();hours=(hours<10)&&"0"+hours||hours;minutes=(minutes<10)&&"0"+minutes||minutes;g=(day_diff==1&&"Yesterday at "+hours+":"+minutes||e.textContent);f=c.toLocaleString()}e.setAttribute("title",f);e.textContent="posted "+g}})}var Page={};var Site={url:"",name:""};var FORBIDDEN_PAGES=["site","delete","edit","create","history","changes","archives"];var Create=Class.create({initialize:function(){var a=this;this.Form=$("fnewpage");this.doCreate=$("doCreate");this.Form.addClassName("hidden");Event.observe(this.doCreate,"click",function(b){Event.stop(b);a.show();return false},false);Event.observe($$("a.cancelCreate")[0],"click",function(b){Event.stop(b);a.cancel();return false},false);$("screate").observe("click",function(b){Event.stop(b);a.submit();return false},false)},show:function(){this.doCreate.addClassName("hidden");this.Form.removeClassName("hidden")},cancel:function(){this.Form.addClassName("hidden");this.doCreate.removeClassName("hidden")},submit:function(){var b=$("title");if(!b.value.match(/^['\-\"\/ !?&.,;:@\(\)\w\u00A1-\uFFFF]+$/i)||FORBIDDEN_PAGES.indexOf(b.value)>=0){alert("Page title invalid");return false}var a=b.value.replace(/ /g,"_");url=Site.url+"/"+a+"#pedit";window.location.href=url;this.Form.addClassName("hidden");this.doCreate.removeClassName("hidden")}});var Compare=Class.create({nb_selected:0,selected:false,initialize:function(){var a=this;this.Form=$("fhistory");$$("input.c").each(function(b){b.observe("click",function(c){a.check(this)},false)})},check:function(a){row=a.parentNode.parentNode;row.toggleClassName("rselected");if(!a.checked){this.nb_selected-=1;a.removeClassName("selected")}else{this.nb_selected+=1;a.addClassName("selected")}if(this.nb_selected==2){$$("input.c").each(function(b){if(!b.hasClassName("selected")){b.disabled="disabled"}});this.selected=true}else{if(this.selected){$$("input.c").each(function(b){if(!b.hasClassName("selected")){b.disabled=null}});this.selected=false}}}});var Diff=Class.create({initialize:function(){var a=this;this.rev_from=$("rev_from");this.rev_to=$("rev_to");$("scompare").observe("click",function(b){Event.stop(b);a.get_diff();return false})},get_diff:function(){var b=this.rev_from.getValue();var a=this.rev_to.getValue();if(b==a){alert("Why would you want compare same version ...");return}url=$("fdiff").action+"?r="+b+"&r="+a;new Ajax.Request(url,{method:"get",contentType:"application/json",requestHeaders:{Accept:"application/json"},onSuccess:function(c){data=c.responseText.evalJSON(true);if(data.ok){Element.remove($("tableDiff"));$("pdiff").insert(data.diff)}}})}});var Settings=Class.create({initialize:function(){var a=this;this.observer=null;this.title=$("site_header").select("h1 a")[0];this.subtitle=$("site_header").select("h2")[0];$$("input").each(function(b){new Form.Element.Observer(b,0.2,function(c,d){if(c.id=="site_title"){a.title.update(d);document.title=d+" - settings"}if(c.id=="site_subtitle"){a.subtitle.update(d)}if(a.observer){clearTimeout(a.observer)}a.observer=setTimeout(a.save.bind(a),400)})})},save:function(){var a={};try{a={title:$("site_title").getValue(),subtitle:$("site_subtitle").getValue(),email:$("email").getValue(),privacy:$$('input:checked[type="radio"][name="privacy"]').pluck("value")[0],allow_javascript:$("allow_javascript").getValue()}}catch(b){a={title:$("site_title").getValue(),subtitle:$("site_subtitle").getValue()}}url=$("fsettings").action;new Ajax.Request(url,{method:"post",postBody:Object.toJSON(a),contentType:"application/json",requestHeaders:{Accept:"application/json"},onSuccess:function(c){a=c.responseText.evalJSON(true)}})}});var SiteAddress=Class.create({initialize:function(){var a=this;if(!$("error").innerHTML){$("error").hide()}new Form.Element.Observer("alias",0.2,function(b,c){if(c.length>3&&!c.match(/^(\w+)$/)){$("error").update("<strong>Error:</strong> "+$("alias").value+" is invalid, only use letters and numbers.");$("error").show()}else{$("error").hide()}});$("faddress").observe("submit",function(d){Event.stop(d);var b=null;var c=$("alias").getValue();if(c.length<=3){b="length < 3"}else{if(!c.match(/^(\w+)$/)){b=c+" is invalid, only use letters and numbers."}}if(b){$("error").update("<strong>Error:</strong> "+b);$("error").show();return false}else{a.valid_name()}},false)},valid_name:function(){url=$("faddress").action;new Ajax.Request(url,{method:"get",contentType:"application/json",parameters:{alias:$("alias").getValue()},requestHeaders:{Accept:"application/json"},onSuccess:function(a){data=a.responseText.evalJSON(true);if(data.ok){$("faddress").submit()}else{$("error").update("<strong>Error:</strong> "+data.error);$("error").show()}}})}});var Claim=Class.create({initialize:function(){var a=this;this.email=$("email");this.password=$("password");$("fclaim").observe("submit",function(b){Event.stop(b);if(a.validate()){this.submit()}return false},false)},validate:function(){$$(".help_error").each(function(b){b.remove()});$$(".errors").each(function(b){b.removeClassName("errors")});nb_errors=0;if(!this.email.value.match(/(^[-!#$%&'*+/=?^_`{}|~0-9A-Z]+(\.[-!#$%&'*+/=?^_`{}|~0-9A-Z]+)*|^"([\001-\010\013\014\016-\037!#-\[\]-\177]|\\[\001-011\013\014\016-\177])*")@(?:[A-Z0-9-]+\.)+[A-Z]{2,6}$/i)){var a=new Element("div",{"class":"help_error"}).update("Invalid email address.");$(this.email.parentNode).insert(a);$("row_email").addClassName("errors");nb_errors+=1}if(this.password.value.length<=0){var a=new Element("div",{"class":"help_error"}).update("You should set a password.");$(this.password.parentNode).insert(a);$("row_password").addClassName("errors");nb_errors+=1}if(nb_errors>0){return false}return true}});document.observe("dom:loaded",function(){localizeDates()});