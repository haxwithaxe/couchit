var PageUI=Class.create({initialize:function(){var A=this;this.Sidebar=$("sidebar");this.Page=$("page");this.tabs=new Control.Tabs("tabs_wiki");this.textarea=new Control.TextArea("content");this.toolbar=new Control.TextArea.ToolBar(this.textarea);this.toolbar.container.id="markdown_toolbar";this.converter=new Showdown.converter;this.converter_callback=function(C){$("preview").update(A.converter.makeHtml(C))};this.converter_callback(this.textarea.getValue());this.textarea.observe("change",A.converter_callback);this.snippet_window=new Control.Window($("snippet_window"),{resizable:true,draggable:$("snippet_window_title"),closeOnClick:$("snippet_window_close")});this.build_toolbar();this.init();this.tabs.observe("beforeChange",function(D,C){if(!Page.created){A.update_tabs(C)}else{var E=window.confirm("Are you sure you want to navigate away from this page?\n\nYou have unsaved changes. Continue and discard those changes?\n\nClick OK to continue, or click Cancel to stay on this page.");if(!E){throw $break}else{history.go(-1)}}});window.onresize=function(D){var C=document.viewport.getHeight()-250;$("content").setStyle({height:C+"px"})};$("cancelEdit").observe("click",function(C){Event.stop(C);A.tabs.setActiveTab("pview");return false});var B=$("page_delete");if(B){B.observe("click",function(C){Event.stop(C);var D=window.confirm("Are you sure you want to delete this page?\n\nClick OK to continue, or click Cancel to stay on this page.");if(!D){return false}document.location.href=this.href},false)}},init:function(){var B=this.tabs.activeContainer;if(B){this.update_tabs(B)}var A=document.viewport.getHeight()-250;$("content").setStyle({height:A+"px"})},update_tabs:function(A){if(A.id=="pedit"){this.Sidebar.hide();this.Page.setStyle({width:"99%"})}else{this.Page.setStyle({width:"76%"});this.Sidebar.show()}},build_toolbar:function(){var A=this;this.toolbar.addButton("Italics",function(){this.wrapSelection("*","*")},{id:"markdown_italics_button"});this.toolbar.addButton("Bold",function(){this.wrapSelection("**","**")},{id:"markdown_bold_button"});this.toolbar.addButton("Link",function(){var C=this.getSelection();var B=prompt("Enter Link URL","");if(B==null){return }this.replaceSelection("["+(C==""?"Link Text":C)+"]("+(B==""?"http://link_url/":B).replace(/^(?!(f|ht)tps?:\/\/)/,"http://")+")")},{id:"markdown_link_button"});this.toolbar.addButton("Image",function(){var C=this.getSelection();var B=prompt("Enter Image URL","");if(B==null){return }this.replaceSelection("!["+(C==""?"Image Alt Text":C)+"]("+(B==""?"http://image_url/":B).replace(/^(?!(f|ht)tps?:\/\/)/,"http://")+")")},{id:"markdown_image_button"});this.toolbar.addButton("Heading",function(){var B=this.getSelection();if(B==""){B="Heading"}this.replaceSelection("\n"+B+"\n"+$R(0,Math.max(5,B.length)).collect(function(){}).join("")+"\n")},{id:"markdown_heading_button"});this.toolbar.addButton("Unordered List",function(B){this.collectFromEachSelectedLine(function(C){return B.shiftKey?(C.match(/^\*{2,}/)?C.replace(/^\*/,""):C.replace(/^\*\s/,"")):(C.match(/\*+\s/)?"*":"* ")+C})},{id:"markdown_unordered_list_button"});this.toolbar.addButton("Ordered List",function(C){var B=0;this.collectFromEachSelectedLine(function(D){if(!D.match(/^\s+$/)){++B;return C.shiftKey?D.replace(/^\d+\.\s/,""):(D.match(/\d+\.\s/)?"":B+". ")+D}})},{id:"markdown_ordered_list_button"});this.toolbar.addButton("Block Quote",function(B){this.collectFromEachSelectedLine(function(C){return B.shiftKey?C.replace(/^\> /,""):"> "+C})},{id:"markdown_quote_button"});this.toolbar.addButton("Code Block",function(B){this.collectFromEachSelectedLine(function(C){return B.shiftKey?C.replace(/    /,""):"    "+C})},{id:"markdown_code_button"});this.toolbar.addButton("Snippet",function(E){var C=this.getSelection();if(C){var B=C.split("\n");if(B[0].match(/\s*:::(\w*)/)){var H=B[0].replace(/\s*:::(\w*)/,"$1");B.splice(0,1);if(H){$("snippet_language").select("option").each(function(I){if(I.value==H){I.selected=true}})}}var D=$A(B).collect(function(I){return I.replace(/    /,"")}).join("\n");$("snippet_content").value=D}A.snippet_window.open();var F=this;var G=function(L){Event.stop(L);var K=$("fsnippet").getInputs("radio","snippet_from");if(K[0].checked){var J=$("snippet_content").getValue();J=$A(J.split("\n")).collect(function(M){M="    "+M;return M}).join("\n");D="\n\n    :::"+$("snippet_language").getValue()+"\n"+J;F.replaceSelection(D);A.snippet_window.close();$("snippet_content").value=""}else{var I="/proxy?url="+encodeURIComponent($("snippet_url").getValue());new Ajax.Request(I,{method:"get",contentType:"application/json",requestHeaders:{Accept:"application/json"},onSuccess:function(M){data=M.responseText.evalJSON(true);J=$A(data.snippet.split("\n")).collect(function(N){return"    "+N}).join("\n");D=" \n\n    :::"+data.language+"\n"+J;F.replaceSelection(D);A.snippet_window.close();$("snippet_content").value=""},onFailure:function(){alert("mmm... error while trying to fetch content from friendpaste:(")}})}return false};$("ssnippet").observe("click",G,false);$("cancelSnippet").observe("click",function(I){Event.stop(I);A.snippet_window.close();return false});$("snippet_url","snippet_language","snippet_content").each(function(I){I.observe("focus",function(J){if(this.id=="snippet_url"){$("sfp").checked=true}else{$("si").checked=true}},false)})},{id:"markdown_snippet_button"});this.toolbar.addButton("Help",function(){window.open("http://daringfireball.net/projects/markdown/dingus")},{id:"markdown_help_button"})}});