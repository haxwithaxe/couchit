var PageUI=Class.create({initialize:function(){this.firstload=true;var a=this;this.Sidebar=$("sidebar");this.Page=$("page");this.tabs=new Control.Tabs("tabs_wiki");this.textarea=new Control.TextArea("content");this.toolbar=new Control.TextArea.ToolBar(this.textarea);this.toolbar.container.id="markdown_toolbar";this.converter=new Showdown.converter;this.converter_callback=function(c){$("preview").innerHTML=a.converter.makeHtml(c)};this.converter_callback(this.textarea.getValue());this.textarea.observe("change",a.converter_callback);this.snippet_window=new Control.Window($("snippet_window"),{resizable:false,draggable:$("snippet_window_title"),closeOnClick:$("snippet_window_close")});this.link_window=new Control.Window($("link_window"),{draggable:$("link_window_title"),closeOnClick:$("link_window_close")});this.link_types_hide={url:"page",page:"url"};this.build_toolbar();this.init();this.tabs.observe("beforeChange",function(d,c){if(!Page.created){a.update_tabs(c)}else{var e=window.confirm("Are you sure you want to navigate away from this page?\n\nYou have unsaved changes. Continue and discard those changes?\n\nClick OK to continue, or click Cancel to stay on this page.");if(!e){throw $break}else{history.go(-1)}}});window.onresize=function(d){var c=document.viewport.getHeight()-250;$("content").setStyle({height:c+"px"})};$("cancelEdit").observe("click",function(c){Event.stop(c);a.tabs.setActiveTab("pview");return false});var b=$("page_delete");if(b){b.observe("click",function(c){Event.stop(c);var d=window.confirm("Are you sure you want to delete this page?\n\nClick OK to continue, or click Cancel to stay on this page.");if(!d){return false}window.location.href=this.href},false)}this._renamingPage=false;if(!Page.created&&!Page.home){this.page_title=$("page_title");this.page_title.setStyle({cursor:"pointer"});this.page_title.title="Click to rename";this.createRenameForm();this.page_title.observe("click",function(c){this._renamingPage=true;a.handleRename()},false)}},init:function(){var b=this.tabs.activeContainer;if(Page.created&&b.id!="pedit"){this.tabs.setActiveTab("pedit");b=this.tabs.activeContainer}if(b){this.update_tabs(b)}var a=document.viewport.getHeight()-250;$("content").setStyle({height:a+"px"})},update_tabs:function(a){if(a.id=="pedit"){this.Sidebar.hide();this.Page.setStyle({width:"99%"});if(this._renamingPage){this.removeRenameForm()}}else{this.Page.setStyle({width:"76%"});this.Sidebar.show()}},build_toolbar:function(){var a=this;this.toolbar.addButton("Italics",function(){this.wrapSelection("*","*")},{id:"markdown_italics_button"});this.toolbar.addButton("Bold",function(){this.wrapSelection("**","**")},{id:"markdown_bold_button"});this.toolbar.addButton("Link",function(){function c(e){$("link_from_"+e).show();$("link_from_"+a.link_types_hide[e]).hide()}insertLinkHandler=function(i){Event.stop(i);var h=$("link_type").getValue();var f=$("link_label").getValue();var j=$("link_page").getValue();var g=$("link_url").getValue();if(j==null||g==null){return}if(h=="page"){b.replaceSelection("["+(f==""?decodeURIComponent(j.replace(Site.url,"").replace(/_/g," ").replace(/\//,"")):f)+"]("+j+")")}else{b.replaceSelection("["+(f==""?"Link Text":f)+"]("+(g==""?"http://link_url/":g)+")")}a.link_window.close();this.stopObserving("click",arguments.callee,false)};a.link_window.open();c($("link_type").getValue());$("cancelLink").observe("click",function(f){Event.stop(f);a.link_window.close();return false});$("link_type").observe("change",function(g){var f=this.getValue();c(f)},false);var b=this;var d=this.getSelection();$("slink").observe("click",insertLinkHandler,false)},{id:"markdown_link_button"});this.toolbar.addButton("Image",function(){var c=this.getSelection();var b=prompt("Enter Image URL","");if(b==null){return}this.replaceSelection("!["+(c==""?"Image Alt Text":c)+"]("+(b==""?"http://image_url/":b).replace(/^(?!(f|ht)tps?:\/\/)/,"http://")+")")},{id:"markdown_image_button"});this.toolbar.addButton("Heading",function(){var b=this.getSelection();if(b==""){b="Heading"}this.replaceSelection("\n"+b+"\n"+$R(0,Math.max(5,b.length)).collect(function(){}).join("")+"\n")},{id:"markdown_heading_button"});this.toolbar.addButton("Unordered List",function(b){this.collectFromEachSelectedLine(function(c){return b.shiftKey?(c.match(/^\*{2,}/)?c.replace(/^\*/,""):c.replace(/^\*\s/,"")):(c.match(/\*+\s/)?"*":"* ")+c})},{id:"markdown_unordered_list_button"});this.toolbar.addButton("Ordered List",function(c){var b=0;this.collectFromEachSelectedLine(function(d){if(!d.match(/^\s+$/)){++b;return c.shiftKey?d.replace(/^\d+\.\s/,""):(d.match(/\d+\.\s/)?"":b+". ")+d}})},{id:"markdown_ordered_list_button"});this.toolbar.addButton("Block Quote",function(b){this.collectFromEachSelectedLine(function(c){return b.shiftKey?c.replace(/^\> /,""):"> "+c})},{id:"markdown_quote_button"});this.toolbar.addButton("Code Block",function(b){this.collectFromEachSelectedLine(function(c){return b.shiftKey?c.replace(/    /,""):"    "+c})},{id:"markdown_code_button"});this.toolbar.addButton("Snippet",function(e){var c=this.getSelection();if(c){var b=c.split("\n");if(b[0].match(/\s*:::(\w*)/)){var h=b[0].replace(/\s*:::(\w*)/,"$1");b.splice(0,1);if(h){$("snippet_language").select("option").each(function(i){if(i.value==h){i.selected=true}})}}var d=$A(b).collect(function(i){return i.replace(/    /,"")}).join("\n");$("snippet_content").value=d}a.snippet_window.open();var f=this;var g=function(l){Event.stop(l);var k=$("fsnippet").getInputs("radio","snippet_from");if(k[0].checked){var j=$("snippet_content").getValue();j=$A(j.split("\n")).collect(function(m){m="    "+m;return m}).join("\n");d="\n\n    :::"+$("snippet_language").getValue()+"\n"+j;f.replaceSelection(d);a.snippet_window.close();$("snippet_content").value=""}else{var i="/proxy?url="+encodeURIComponent($("snippet_url").getValue());new Ajax.Request(i,{method:"get",contentType:"application/json",requestHeaders:{Accept:"application/json"},onSuccess:function(m){data=m.responseText.evalJSON(true);j=$A(data.snippet.split("\n")).collect(function(n){return"    "+n}).join("\n");d=" \n\n    :::"+data.language+"\n"+j;f.replaceSelection(d);a.snippet_window.close();$("snippet_content").value=""},onFailure:function(){alert("mmm... error while trying to fetch content from friendpaste:(")}})}this.stopObserving("click",arguments.callee,false)};$("ssnippet").observe("click",g,false);$("cancelSnippet").observe("click",function(i){Event.stop(i);a.snippet_window.close();return false});$("snippet_url","snippet_language","snippet_content").each(function(i){i.observe("focus",function(j){if(this.id=="snippet_url"){$("sfp").checked=true}else{$("si").checked=true}},false)})},{id:"markdown_snippet_button"});this.toolbar.addButton("Help",function(){window.open("http://help.couch.it/Markdown_Syntax")},{id:"markdown_help_button"})},createRenameForm:function(){var d=$("fedit").action;this._form=new Element("form",{id:"frename",method:"post",action:d});var a=new Element("input",{type:"text",id:"new_title",name:"new_title",maxlength:"60",value:$("page_title").innerHTML});var b=new Element("input",{type:"hidden",id:"old_title",name:"old_title",value:$("page_title").innerHTML});var c=new Element("a",{id:"rcancel","class":"cancel",href:"#"}).update("Cancel");this._form.insert(b);this._form.insert(a);this._form.insert(c);this._form.onsubmit=this.renamePage.bind(this)},renamePage:function(c){Event.stop(c);var b=$("new_title").getValue();var a=$("old_title").getValue();if(!b){alert("Page title can't be empty.")}else{if(a==b){this.removeRenameForm()}else{if(!b.match(/^['\-\"\/ !?;,:&.@\(\)\w\u00A1-\uFFFF]+$/i)||FORBIDDEN_PAGES.indexOf(b)>=0){alert("Page title invalid");this.removeRenameForm();return false}new Ajax.Request(this._form.action,{method:"post",contentType:"application/json",requestHeaders:{Accept:"application/json"},postBody:Object.toJSON(this._form.serialize(true)),onSuccess:function(d){data=d.responseText.evalJSON(true);if(data.ok){this._renamingPage=false;document.location.href=data.redirect_url}else{alert(data.error)}},onFailure:function(){alert("mmm... error while trying rename :(, Please contact administrator")}})}}},createRenameHelp:function(){var a=this;this._help=new Element("div",{"class":"rename hidden"}).update("&#x21E4; Click to rename");this.page_title.insert(this._help);this.page_title.observe("mouseover",function(b){a._help.removeClassName("hidden")},false);this.page_title.observe("mouseout",function(b){a._help.addClassName("hidden")},false)},removeRenameForm:function(){this._form.remove();this.createRenameForm();this.page_title.show();this._renamingPage=false},handleRename:function(){var a=this;this.page_title.hide();this.page_title.parentNode.insertBefore(this._form,$("page_title"));this._form.select(".cancel").each(function(b){b.observe("click",function(c){Event.stop(c);a.removeRenameForm();return false},false)})}});